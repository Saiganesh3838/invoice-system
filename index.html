<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üõí Smart Invoice System</title>
  
  <style>
    /* 1. THEMES & COLORS */
    :root { 
      --primary: #1a73e8; 
      --success: #34a853; 
      --danger: #d93025; 
      --bg: #f8f9fa;
      --card-bg: #ffffff;
      --text: #202124;
      --border: #dadce0;
      --input-bg: #ffffff;
      --panel-border: #eeeeee;
      --summary-bg: #f1f3f4;
      --unit-btn-bg: #ffffff;
    }

    [data-theme="dark"] {
      --bg: #121212;
      --card-bg: #1e1e1e;
      --text: #e8eaed;
      --border: #3c4043;
      --input-bg: #2d2e31;
      --panel-border: #333333;
      --summary-bg: #2d2e31;
      --primary: #8ab4f8;
      --unit-btn-bg: #2d2e31;
    }

    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      background: var(--bg); 
      color: var(--text);
      margin: 0; padding: 20px; height: 100vh; box-sizing: border-box;
      transition: background 0.3s, color 0.3s;
    }

    .app-container { 
      background: var(--card-bg); border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); 
      max-width: 1400px; margin: auto; display: grid; grid-template-columns: 420px 1fr; 
      gap: 25px; padding: 25px; min-height: 85vh; border: 1px solid var(--border);
    }

    .entry-panel { border-right: 1px solid var(--panel-border); padding-right: 25px; }
    .bill-panel { display: flex; flex-direction: column; }

    h1 { font-size: 1.5rem; color: var(--primary); margin-top: 0; border-bottom: 2px solid var(--primary); padding-bottom: 10px; }
    
    .input-group { background: var(--summary-bg); padding: 20px; border-radius: 10px; border: 1px solid var(--border); margin-bottom: 15px; }
    label { font-size: 0.8rem; font-weight: bold; opacity: 0.8; display: block; margin-bottom: 8px; text-transform: uppercase; }
    
    input { 
      width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 6px; 
      font-size: 18px; box-sizing: border-box; margin-bottom: 15px; background: var(--input-bg); color: var(--text);
    }

    /* UNIT SELECTOR */
    .unit-selector { display: flex; gap: 8px; margin-bottom: 20px; }
    .unit-btn {
      flex: 1; padding: 12px; background: var(--unit-btn-bg); border: 2px solid var(--border);
      color: var(--text); border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s;
    }
    .unit-btn.active { background: var(--primary); color: #000 !important; border-color: var(--primary); }

    /* SEARCH SUGGESTIONS */
    .search-container { position: relative; }
    #suggestions { 
      position: absolute; width: 100%; background: var(--card-bg); border: 1px solid var(--border); 
      max-height: 300px; overflow-y: auto; z-index: 1000; border-radius: 8px;
    }
    .suggestion-item { padding: 15px; border-bottom: 1px solid var(--border); cursor: pointer; }
    .suggestion-item.active { background-color: var(--primary) !important; color: #000; }

    /* BUTTONS */
    .row-flex { display: flex; gap: 12px; }
    button { padding: 12px 20px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.2s; }
    .add-btn { background: var(--primary); color: #000; width: 100%; height: 50px; margin-top: 10px; font-size: 1rem; }
    
    /* SMALL PRINT BUTTON STYLING */
    .print-btn-container { text-align: center; margin-top: 20px; }
    .print-btn { 
      background: var(--success); 
      color: white; 
      padding: 10px 30px; 
      font-size: 0.9rem; 
      width: auto; 
      min-width: 150px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .print-btn:hover { background: #2d8d46; transform: translateY(-1px); }

    .remove-btn { background: none; color: var(--danger); font-size: 22px; padding: 0; }

    .table-scroll { flex-grow: 1; overflow-y: auto; max-height: 480px; border: 1px solid var(--border); border-radius: 8px; margin-top: 10px;}
    table { width: 100%; border-collapse: collapse; }
    th { position: sticky; top: 0; background: var(--summary-bg); padding: 15px; text-align: left; border-bottom: 2px solid var(--border); z-index: 5; }
    td { padding: 15px; border-bottom: 1px solid var(--panel-border); font-size: 1.1rem; }
    
    .summary-section { margin-top: 20px; padding: 20px; background: var(--summary-bg); border-radius: 10px; }
    .grand-total { text-align: right; font-size: 2.5rem; font-weight: bold; margin-top: 10px; border-top: 3px solid var(--text); padding-top: 10px; }

    /* UTILITY BUTTONS */
    .theme-toggle-container { position: fixed; bottom: 20px; left: 20px; z-index: 2000; }
    .theme-btn {
      background: #fbbc04; color: black; border-radius: 50px; padding: 8px 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2); font-size: 13px;
    }
    .fs-btn {
      position: fixed; top: 10px; right: 10px; background: #5f6368; color: white;
      font-size: 12px; padding: 6px 10px; opacity: 0.6;
    }

    #invoice-header { display: none; text-align: center; color: black !important; }

    @media print {
      .no-print, .theme-toggle-container, .fs-btn { display: none !important; }
      #invoice-header { display: block; }
      .app-container { display: block; background: white; border: none; padding: 0; }
      td, th { color: black; border-color: #ddd; }
      @page { size: 80mm auto; margin: 5mm; }
    }
  </style>
</head>
<body>

<button class="fs-btn no-print" onclick="toggleFullScreen()">‚õ∂ Full Screen</button>

<div class="theme-toggle-container no-print">
  <button class="theme-btn" onclick="toggleTheme()">üåì Switch Theme</button>
</div>

<div class="app-container">
  <div class="entry-panel no-print">
    <h1>üõí Smart Invoice</h1>
    <div id="sync-status" style="font-size: 12px; margin-bottom: 10px; display: flex; justify-content: space-between;">
      <span id="status-text">üîÑ Syncing...</span>
      <span style="color:var(--primary); cursor: pointer;" onclick="loadInventory()">REFRESH</span>
    </div>
    
    <div class="input-group">
      <label>Product Name</label>
      <div class="search-container">
        <input type="text" id="pSearch" placeholder="Search item..." onkeyup="handleSearch(event)" autocomplete="off">
        <div id="suggestions"></div>
      </div>

      <div class="row-flex">
        <div style="flex: 1;">
          <label>Price (‚Çπ)</label>
          <input type="number" id="pPrice" placeholder="0.00" step="0.01">
        </div>
        <div style="flex: 1;">
          <label>Qty</label>
          <input type="number" id="pQty" value="1" step="0.01">
        </div>
      </div>

      <label>Select Unit</label>
      <div class="unit-selector">
        <button class="unit-btn active" onclick="setUnit('kg', this)">kg</button>
        <button class="unit-btn" onclick="setUnit('g', this)">g</button>
        <button class="unit-btn" onclick="setUnit('pcs', this)">pcs</button>
        <button class="unit-btn" onclick="setUnit('ltr', this)">ltr</button>
      </div>
      
      <button class="add-btn" onclick="addItem()">ADD TO BILL (Enter)</button>
    </div>
  </div>

  <div class="bill-panel">
    <div id="invoice-header">
        <h2 style="margin: 0;">CHENNA MALLESHWARA PROVISION STORE</h2>
        <p style="margin: 5px 0;">Contact: +91 944101885</p>
        <p>Date: <span id="pDate"></span> | Bill: #<span id="pInv"></span></p>
        <hr>
    </div>

    <div class="table-scroll">
      <table>
        <thead>
          <tr>
            <th style="width: 45%;">Items</th>
            <th>Price</th>
            <th>Qty</th>
            <th style="text-align: right;">Total</th>
            <th class="no-print"></th>
          </tr>
        </thead>
        <tbody id="billBody"></tbody>
      </table>
    </div>

    <div class="summary-section">
      <div class="summary-row"><span>Subtotal:</span><span id="subTotal">‚Çπ0.00</span></div>
      <div class="grand-total">Total: ‚Çπ<span id="gTotal">0.00</span></div>
      <div class="print-btn-container no-print">
        <button class="print-btn" onclick="printInvoice()">üñ®Ô∏è Print Receipt</button>
      </div>
    </div>
  </div>
</div>

<script>
  const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQF6tUzPPv0vZI-8ZxzlPMqpAzBZ4QIovDhFDkTrObeCnAQ5uThQTyKT9a8l2la_pWaxEMtuPio0aIR/pub?output=csv';
  let inventory = [], invNo = parseInt(localStorage.getItem('mInv')) || 1001, currentFocus = -1, selectedUnit = 'kg';

  function toggleTheme() {
    const current = document.documentElement.getAttribute('data-theme');
    const target = current === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', target);
    localStorage.setItem('theme', target);
  }
  if (localStorage.getItem('theme') === 'dark') document.documentElement.setAttribute('data-theme', 'dark');

  async function loadInventory() {
    const st = document.getElementById('status-text');
    try {
      const res = await fetch(CSV_URL + '&cb=' + Date.now());
      const data = await res.text();
      inventory = data.split(/\r?\n/).map(r => r.split(',')[0].replace(/^"|"$/g, '').trim()).filter(i => i && !['items','product name'].includes(i.toLowerCase()));
      st.innerText = "‚úÖ Synced";
      localStorage.setItem('cachedInventory', JSON.stringify(inventory));
    } catch (e) {
      inventory = JSON.parse(localStorage.getItem('cachedInventory')) || [];
      st.innerText = "‚ö†Ô∏è Offline";
    }
  }

  function setUnit(u, b) {
    selectedUnit = u;
    document.querySelectorAll('.unit-btn').forEach(btn => btn.classList.remove('active'));
    b.classList.add('active');
  }

  document.addEventListener('keydown', (e) => {
    const suggs = document.getElementById("suggestions");
    const items = suggs.getElementsByClassName("suggestion-item");
    if (e.key === "ArrowDown") { currentFocus++; addActive(items); }
    else if (e.key === "ArrowUp") { currentFocus--; addActive(items); }
    else if (e.key === "Enter") {
      const activeEl = document.activeElement;
      if (activeEl.id === 'pSearch') {
        if (currentFocus > -1) items[currentFocus].click();
        else if (items.length > 0) items[0].click();
        else if (activeEl.value) document.getElementById("pPrice").focus();
      } else if (activeEl.id === "pPrice") document.getElementById("pQty").focus();
      else if (activeEl.id === "pQty") document.querySelector('.unit-btn').focus();
      else if (activeEl.classList.contains('unit-btn')) { activeEl.click(); addItem(); }
    }
  });

  function handleSearch(e) { if (!["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) searchItem(); }

  function searchItem() {
    let q = document.getElementById("pSearch").value.toLowerCase(), s = document.getElementById("suggestions");
    s.innerHTML = ""; currentFocus = -1;
    if (q.length < 1) return;
    inventory.filter(n => n.toLowerCase().includes(q)).slice(0,12).forEach(m => {
      let d = document.createElement("div"); d.className = "suggestion-item"; d.innerText = m;
      d.onclick = () => { document.getElementById("pSearch").value = m; s.innerHTML = ""; document.getElementById("pPrice").focus(); };
      s.appendChild(d);
    });
  }

  function addActive(items) {
    if (!items.length) return;
    [...items].forEach(i => i.classList.remove("active"));
    currentFocus = (currentFocus + items.length) % items.length;
    items[currentFocus].classList.add("active");
  }

  function addItem() {
    let n = document.getElementById("pSearch").value, p = parseFloat(document.getElementById("pPrice").value), q = parseFloat(document.getElementById("pQty").value);
    if (!n || isNaN(p) || isNaN(q)) return alert("Check inputs!");
    let total = p * (selectedUnit === 'g' ? q / 1000 : q);
    let tr = document.createElement("tr");
    tr.innerHTML = `<td><strong>${n}</strong></td><td>‚Çπ${p.toFixed(2)}</td><td>${q}${selectedUnit}</td><td style="text-align:right" class="r-tot" data-v="${total}">‚Çπ${total.toFixed(2)}</td><td class="no-print" style="text-align:center"><button class="remove-btn" onclick="this.parentElement.parentElement.remove(); calc();">‚úï</button></td>`;
    document.getElementById("billBody").appendChild(tr);
    calc();
    document.getElementById("pSearch").value = ""; document.getElementById("pPrice").value = ""; document.getElementById("pQty").value = "1";
    setUnit('kg', document.querySelector('.unit-btn')); document.getElementById("pSearch").focus();
  }

  function calc() {
    let sub = 0; document.querySelectorAll(".r-tot").forEach(c => sub += parseFloat(c.dataset.v));
    document.getElementById("subTotal").innerText = "‚Çπ" + sub.toFixed(2);
    document.getElementById("gTotal").innerText = sub.toFixed(2);
  }

  function printInvoice() {
    if(!document.querySelectorAll("#billBody tr").length) return;
    document.getElementById("pDate").innerText = new Date().toLocaleString();
    document.getElementById("pInv").innerText = invNo++;
    localStorage.setItem('mInv', invNo);
    window.print();
  }

  function toggleFullScreen() {
    if (!document.fullscreenElement) document.documentElement.requestFullscreen();
    else document.exitFullscreen();
  }

  window.onclick = (e) => { if (!e.target.matches('#pSearch')) document.getElementById("suggestions").innerHTML = ""; };
  window.onload = loadInventory;
</script>
</body>
</html>
